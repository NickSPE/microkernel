"""
MICROKERNEL COMPLETO - TODO EN UNO
==================================
Sistema completo con:
- Simulaci√≥n de fallos (fail/recover)
- Interacci√≥n directa con servicios (use)
- Verificaci√≥n de funcionamiento (test)
- Estado de servicios (status)
- Comandos de ayuda (help)
"""

import sys
import os
import time
import threading

# Agregar el directorio actual al path
sys.path.insert(0, os.path.abspath('.'))

# Importar todo
from kernel.microkernel import Microkernel
from services.fs_service import FileSystemService
from services.net_service import NetworkService
from services.driver_service import DriverService
from services.security_service import SecurityService

class MicrokernelCompleto:
    def __init__(self):
        """Inicializar el microkernel completo"""
        print("üöÄ INICIANDO MICROKERNEL COMPLETO...")
        print("="*50)
        
        # Crear kernel y servicios
        self.kernel = Microkernel()
        
        # Registrar servicios
        self.fs_service = FileSystemService()
        self.net_service = NetworkService()
        self.driver_service = DriverService()
        self.security_service = SecurityService()
        
        # Registrar en el kernel
        self.kernel.register_service("fs", self.fs_service)
        self.kernel.register_service("net", self.net_service)
        self.kernel.register_service("driver", self.driver_service)
        self.kernel.register_service("security", self.security_service)
        
        # Iniciar el kernel
        self.kernel.start()
        
        # Iniciar cada servicio manualmente
        self.fs_service.start()
        self.net_service.start()
        self.driver_service.start()
        self.security_service.start()
        time.sleep(1)  # Dar tiempo a los hilos
        
        print("‚úÖ MICROKERNEL COMPLETO INICIADO")
        print("="*50)

    def _print_help(self):
        """Mostrar ayuda completa"""
        print("\n" + "="*60)
        print("üéÆ COMANDOS DISPONIBLES")
        print("="*60)
        print("üìä ESTADO:")
        print("  status                    - Estado de todos los servicios")
        print("  status <servicio>         - Estado de un servicio espec√≠fico")
        print("")
        print("üí• SIMULACI√ìN DE FALLOS:")
        print("  fail <servicio>          - Hacer fallar un servicio")
        print("  recover <servicio>       - Recuperar un servicio")
        print("")
        print("üß™ VERIFICACI√ìN:")
        print("  test                     - Probar todos los servicios")
        print("  test <servicio>          - Probar un servicio espec√≠fico")
        print("")
        print("üéØ USO DIRECTO:")
        print("  use fs create <archivo> <contenido>    - Crear archivo")
        print("  use fs read <archivo>                  - Leer archivo")
        print("  use fs list                            - Listar archivos")
        print("  use net resolve <dominio>              - Resolver DNS")
        print("  use net interfaces                     - Ver interfaces")
        print("  use driver list                        - Listar dispositivos")
        print("  use driver read <device> <bytes>       - Leer dispositivo")
        print("  use security login <user> <pass>       - Login")
        print("  use security users                     - Ver usuarios")
        print("")
        print("üìç INSPECCI√ìN INTERNA:")
        print("  inspect fs                - Ver d√≥nde se guardan archivos")
        print("  inspect net               - Ver cach√© DNS y config")
        print("  inspect driver            - Ver dispositivos en memoria")
        print("  inspect security          - Ver usuarios y sesiones")
        print("")
        print("‚ùì OTROS:")
        print("  help                     - Esta ayuda")
        print("  demo                     - Demostraci√≥n autom√°tica")
        print("  exit                     - Salir")
        print("="*60)

    def _handle_status(self, args):
        """Manejar comando status"""
        if not args:
            # Estado de todos
            print("\nüìä ESTADO DE TODOS LOS SERVICIOS:")
            print("-" * 40)
            services = ["fs", "net", "driver", "security"]
            for service_name in services:
                service = getattr(self, f"{service_name}_service")
                status = "üî¥ FALLADO" if service.failed else "üü¢ FUNCIONANDO"
                health = "‚ùå NO SALUDABLE" if service.failed else "‚úÖ SALUDABLE"
                print(f"  {service_name:12} ‚Üí {status} ({health})")
        else:
            # Estado espec√≠fico
            service_name = args[0]
            if hasattr(self, f"{service_name}_service"):
                service = getattr(self, f"{service_name}_service")
                print(f"\nüìã ESTADO DETALLADO DE {service_name.upper()}:")
                print("-" * 30)
                print(f"Estado: {'üî¥ FALLADO' if service.failed else 'üü¢ FUNCIONANDO'}")
                print(f"Salud: {'‚ùå NO SALUDABLE' if service.failed else '‚úÖ SALUDABLE'}")
                
                # Informaci√≥n espec√≠fica del servicio
                if service_name == "fs":
                    files_count = len(service.root_dir.files)
                    print(f"Archivos: {files_count}")
                elif service_name == "net":
                    dns_entries = len(service.dns_cache)
                    interfaces_up = sum(1 for iface in service.network_interfaces.values() if iface['status'] == 'up')
                    print(f"DNS Cache: {dns_entries} entradas")
                    print(f"Interfaces activas: {interfaces_up}")
                elif service_name == "driver":
                    devices_online = len([d for d in service.devices.values() if d.state.value == 'online'])
                    total_devices = len(service.devices)
                    print(f"Dispositivos: {devices_online}/{total_devices} online")
                elif service_name == "security":
                    active_sessions = len(service.active_sessions)
                    total_users = len(service.users)
                    print(f"Sesiones activas: {active_sessions}")
                    print(f"Usuarios totales: {total_users}")
            else:
                print(f"‚ùå Servicio '{service_name}' no encontrado")

    def _handle_fail(self, args):
        """Manejar comando fail"""
        if not args:
            print("‚ùå Uso: fail <servicio>")
            print("   Servicios: fs, net, driver, security")
            return
        
        service_name = args[0]
        if hasattr(self, f"{service_name}_service"):
            service = getattr(self, f"{service_name}_service")
            service.failed = True
            print(f"üí• {service_name.upper()}: Servicio marcado como FALLADO")
            print(f"üî¥ Todas las operaciones de {service_name} ahora fallar√°n")
        else:
            print(f"‚ùå Servicio '{service_name}' no encontrado")

    def _handle_recover(self, args):
        """Manejar comando recover"""
        if not args:
            print("‚ùå Uso: recover <servicio>")
            return
        
        service_name = args[0]
        if hasattr(self, f"{service_name}_service"):
            service = getattr(self, f"{service_name}_service")
            service.failed = False
            print(f"üîÑ {service_name.upper()}: Servicio RECUPERADO")
            print(f"üü¢ Todas las operaciones de {service_name} ahora funcionar√°n")
        else:
            print(f"‚ùå Servicio '{service_name}' no encontrado")

    def _handle_test(self, args):
        """Manejar comando test"""
        if not args:
            # Probar todos
            print("\nüß™ PROBANDO TODOS LOS SERVICIOS:")
            print("=" * 40)
            services = ["fs", "net", "driver", "security"]
            for service_name in services:
                self._test_service(service_name)
                print()
        else:
            # Probar espec√≠fico
            service_name = args[0]
            if hasattr(self, f"{service_name}_service"):
                print(f"\nüß™ PROBANDO {service_name.upper()}:")
                print("-" * 30)
                self._test_service(service_name)
            else:
                print(f"‚ùå Servicio '{service_name}' no encontrado")

    def _test_service(self, service_name):
        """Probar un servicio espec√≠fico"""
        try:
            if service_name == "fs":
                # Probar crear, leer archivo
                success = self.fs_service.create_file("test_file.txt", "contenido de prueba", "admin")
                print(f"üìÅ Crear archivo: {'‚úÖ OK' if success else '‚ùå FALLO'}")
                
                if success:
                    content = self.fs_service.read_file("test_file.txt", "admin")
                    print(f"üìñ Leer archivo: {'‚úÖ OK' if content else '‚ùå FALLO'}")
                
            elif service_name == "net":
                # Probar DNS
                ip = self.net_service.resolve_dns("test-domain.com")
                print(f"üåê Resolver DNS: {'‚úÖ OK' if ip else '‚ùå FALLO'}")
                
            elif service_name == "driver":
                # Probar leer dispositivo
                data = self.driver_service.device_read("hdd0", 128, "admin")
                print(f"üíæ Leer dispositivo: {'‚úÖ OK' if data else '‚ùå FALLO'}")
                
            elif service_name == "security":
                # Probar login
                token = self.security_service.login("admin", "admin123")
                print(f"üîí Login: {'‚úÖ OK' if token else '‚ùå FALLO'}")
                if token:
                    valid = self.security_service.validate_session(token)
                    print(f"‚úÖ Validar sesi√≥n: {'‚úÖ OK' if valid else '‚ùå FALLO'}")
                    self.security_service.logout(token)
                
        except Exception as e:
            print(f"üí• Error en test: {e}")

    def _handle_use(self, args):
        """Manejar comandos de uso directo"""
        if len(args) < 2:
            print("‚ùå Uso: use <servicio> <acci√≥n> [par√°metros...]")
            print("   Ejemplo: use fs create mi_archivo.txt 'contenido'")
            return
        
        service_name = args[0]
        action = args[1]
        
        try:
            if service_name == "fs":
                self._use_filesystem(action, args[2:])
            elif service_name == "net":
                self._use_network(action, args[2:])
            elif service_name == "driver":
                self._use_driver(action, args[2:])
            elif service_name == "security":
                self._use_security(action, args[2:])
            else:
                print(f"‚ùå Servicio '{service_name}' no soportado para 'use'")
        except Exception as e:
            print(f"üí• Error: {e}")

    def _use_filesystem(self, action, args):
        """Usar sistema de archivos directamente"""
        if action == "create":
            if len(args) < 2:
                print("‚ùå Uso: use fs create <archivo> <contenido>")
                return
            filename = args[0]
            content = " ".join(args[1:])  # Unir todo el contenido
            success = self.fs_service.create_file(filename, content, "admin")
            if success:
                print(f"‚úÖ Archivo '{filename}' creado exitosamente")
                print(f"üóÇÔ∏è Guardado en: fs_service.root_dir.files['{filename}']")
            else:
                print(f"‚ùå Error al crear archivo '{filename}'")
                
        elif action == "read":
            if not args:
                print("‚ùå Uso: use fs read <archivo>")
                return
            filename = args[0]
            content = self.fs_service.read_file(filename, "admin")
            if content:
                print(f"üìÑ Contenido de '{filename}':")
                print(f"üìù {content}")
            else:
                print(f"‚ùå No se pudo leer '{filename}' (no existe o servicio fallado)")
                
        elif action == "list":
            files = self.fs_service.list_directory("/")
            print("üìÇ Archivos disponibles:")
            for file_info in files:
                print(f"   üìÑ {file_info}")
        else:
            print(f"‚ùå Acci√≥n '{action}' no soportada para fs")

    def _use_network(self, action, args):
        """Usar servicio de red directamente"""
        if action == "resolve":
            if not args:
                print("‚ùå Uso: use net resolve <dominio>")
                return
            domain = args[0]
            ip = self.net_service.resolve_dns(domain)
            if ip:
                print(f"üìç {domain} ‚Üí {ip}")
                print(f"üóÑÔ∏è Guardado en: net_service.dns_cache['{domain}']")
            else:
                print(f"‚ùå No se pudo resolver '{domain}'")
                
        elif action == "interfaces":
            print("üîå Interfaces de red:")
            for name, info in self.net_service.network_interfaces.items():
                status = "üü¢" if info['status'] == 'up' else "üî¥"
                print(f"   {status} {name}: {info['address']} (MTU: {info['mtu']})")
        else:
            print(f"‚ùå Acci√≥n '{action}' no soportada para net")

    def _use_driver(self, action, args):
        """Usar controladores directamente"""
        if action == "list":
            print("üîß Dispositivos disponibles:")
            devices = self.driver_service.list_devices()
            for device in devices:
                status = "üü¢" if device.state.value == 'online' else "üî¥"
                print(f"   {status} {device.device_id}: {device.name} ({device.device_type.value})")
                
        elif action == "read":
            if len(args) < 2:
                print("‚ùå Uso: use driver read <device_id> <bytes>")
                return
            device_id = args[0]
            try:
                bytes_to_read = int(args[1])
                data = self.driver_service.device_read(device_id, bytes_to_read, "admin")
                if data:
                    print(f"üìñ Le√≠dos {len(data)} bytes de {device_id}")
                    print(f"üî¢ Primeros 20 bytes: {data[:20]}")
                else:
                    print(f"‚ùå No se pudo leer de '{device_id}'")
            except ValueError:
                print("‚ùå El n√∫mero de bytes debe ser un entero")
        else:
            print(f"‚ùå Acci√≥n '{action}' no soportada para driver")

    def _use_security(self, action, args):
        """Usar seguridad directamente"""
        if action == "login":
            if len(args) < 2:
                print("‚ùå Uso: use security login <usuario> <password>")
                return
            username = args[0]
            password = args[1]
            token = self.security_service.login(username, password)
            if token:
                print(f"‚úÖ Login exitoso para '{username}'")
                print(f"üîë Token: {token[:20]}...")
                print(f"üóÇÔ∏è Guardado en: security_service.active_sessions")
            else:
                print(f"‚ùå Login fallido para '{username}'")
                
        elif action == "users":
            print("üë• Usuarios del sistema:")
            for username, user in self.security_service.users.items():
                status = "üîí" if user.is_locked else "üîì"
                last = "Nunca" if not user.last_login else "Recientemente"
                print(f"   {status} {username} - √öltimo login: {last}")
        else:
            print(f"‚ùå Acci√≥n '{action}' no soportada para security")

    def _handle_inspect(self, args):
        """Inspeccionar d√≥nde se guardan los datos internamente"""
        if not args:
            print("‚ùå Uso: inspect <servicio>")
            print("   Servicios: fs, net, driver, security")
            return
            
        service_name = args[0]
        
        if service_name == "fs":
            print("üîç INSPECCI√ìN INTERNA - SISTEMA DE ARCHIVOS:")
            print("-" * 45)
            print(f"üìç Ubicaci√≥n: fs_service.root_dir.files")
            print(f"üìä Total archivos: {len(self.fs_service.root_dir.files)}")
            print("üìÑ Archivos en memoria:")
            for filename, file_obj in self.fs_service.root_dir.files.items():
                print(f"   ‚Ä¢ {filename}:")
                print(f"     ‚îî‚îÄ Objeto: VirtualFile")
                print(f"     ‚îî‚îÄ Tama√±o: {file_obj.size} bytes")
                print(f"     ‚îî‚îÄ Owner: {file_obj.owner}")
                print(f"     ‚îî‚îÄ Content: '{file_obj.content[:30]}{'...' if len(file_obj.content) > 30 else ''}'")
                
        elif service_name == "net":
            print("üîç INSPECCI√ìN INTERNA - SERVICIO DE RED:")
            print("-" * 40)
            print(f"üìç DNS Cache: net_service.dns_cache")
            print(f"üìä Entradas DNS: {len(self.net_service.dns_cache)}")
            for domain, ip in self.net_service.dns_cache.items():
                print(f"   üåê {domain} ‚Üí {ip}")
            print(f"üìç Interfaces: net_service.network_interfaces")
            print(f"üìä Interfaces: {len(self.net_service.network_interfaces)}")
            for name, config in self.net_service.network_interfaces.items():
                print(f"   üîå {name}: {config}")
                
        elif service_name == "driver":
            print("üîç INSPECCI√ìN INTERNA - CONTROLADORES:")
            print("-" * 38)
            print(f"üìç Ubicaci√≥n: driver_service.devices")
            print(f"üìä Total dispositivos: {len(self.driver_service.devices)}")
            for device_id, device in self.driver_service.devices.items():
                print(f"   üíæ {device_id}:")
                print(f"     ‚îî‚îÄ Objeto: VirtualDevice")
                print(f"     ‚îî‚îÄ Nombre: {device.name}")
                print(f"     ‚îî‚îÄ Estado: {device.state.value}")
                print(f"     ‚îî‚îÄ Operaciones: {device.operations_count}")
                print(f"     ‚îî‚îÄ Stats: {device.stats}")
                
        elif service_name == "security":
            print("üîç INSPECCI√ìN INTERNA - SEGURIDAD:")
            print("-" * 35)
            print(f"üìç Usuarios: security_service.users")
            print(f"üìä Total usuarios: {len(self.security_service.users)}")
            for username, user in self.security_service.users.items():
                print(f"   üë§ {username}:")
                print(f"     ‚îî‚îÄ Objeto: User")
                print(f"     ‚îî‚îÄ Locked: {user.is_locked}")
                print(f"     ‚îî‚îÄ Last login: {user.last_login}")
            print(f"üìç Sesiones: security_service.active_sessions")
            print(f"üìä Sesiones activas: {len(self.security_service.active_sessions)}")
        else:
            print(f"‚ùå Servicio '{service_name}' no encontrado")

    def _handle_demo(self):
        """Demostraci√≥n autom√°tica completa"""
        print("\nüé≠ DEMOSTRACI√ìN AUTOM√ÅTICA COMPLETA")
        print("=" * 50)
        
        print("\n1Ô∏è‚É£ Creando archivo de prueba...")
        self.fs_service.create_file("demo.txt", "Archivo de demostraci√≥n", "admin")
        print("‚úÖ Archivo creado")
        
        print("\n2Ô∏è‚É£ Resolviendo DNS...")
        ip = self.net_service.resolve_dns("demo.microkernel.local")
        print(f"üåê demo.microkernel.local ‚Üí {ip}")
        
        print("\n3Ô∏è‚É£ Leyendo dispositivo...")
        data = self.driver_service.device_read("hdd0", 64, "admin")
        print(f"üíæ Le√≠dos {len(data)} bytes del disco")
        
        print("\n4Ô∏è‚É£ Login de usuario...")
        token = self.security_service.login("admin", "admin123")
        print(f"üîí Login exitoso - Token: {token[:15]}...")
        
        print("\n5Ô∏è‚É£ Simulando fallo del sistema de archivos...")
        self.fs_service.failed = True
        success = self.fs_service.create_file("fallo.txt", "No deber√≠a funcionar", "admin")
        print(f"üí• Crear archivo con servicio fallado: {'‚ùå FALL√ì' if not success else '‚úÖ FUNCION√ì'}")
        
        print("\n6Ô∏è‚É£ Recuperando servicio...")
        self.fs_service.failed = False
        success = self.fs_service.create_file("recuperado.txt", "Ahora funciona", "admin")
        print(f"üîÑ Crear archivo recuperado: {'‚úÖ FUNCION√ì' if success else '‚ùå FALL√ì'}")
        
        if token:
            self.security_service.logout(token)
            print("üëã Logout realizado")
        
        print("\n‚úÖ DEMOSTRACI√ìN COMPLETADA")

    def run(self):
        """Ejecutar el microkernel interactivo"""
        print("\nüéÆ MICROKERNEL INTERACTIVO")
        print("Escribe 'help' para ver todos los comandos disponibles")
        print("Escribe 'exit' para salir")
        
        while True:
            try:
                command_input = input("\nüéÆ microkernel> ").strip()
                
                if not command_input:
                    continue
                    
                parts = command_input.split()
                command = parts[0].lower()
                args = parts[1:]
                
                if command == "help":
                    self._print_help()
                elif command == "status":
                    self._handle_status(args)
                elif command == "fail":
                    self._handle_fail(args)
                elif command == "recover":
                    self._handle_recover(args)
                elif command == "test":
                    self._handle_test(args)
                elif command == "use":
                    self._handle_use(args)
                elif command == "inspect":
                    self._handle_inspect(args)
                elif command == "demo":
                    self._handle_demo()
                elif command == "exit":
                    print("üëã ¬°Hasta luego!")
                    break
                else:
                    print(f"‚ùå Comando '{command}' no reconocido. Escribe 'help' para ver los comandos disponibles.")
                    
            except KeyboardInterrupt:
                print("\nüëã ¬°Hasta luego!")
                break
            except Exception as e:
                print(f"üí• Error: {e}")

def main():
    """Funci√≥n principal"""
    try:
        microkernel = MicrokernelCompleto()
        microkernel.run()
    except KeyboardInterrupt:
        print("\nüëã Programa interrumpido")
    except Exception as e:
        print(f"üí• Error fatal: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()